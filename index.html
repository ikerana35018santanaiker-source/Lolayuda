<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MiniCraft 3D â€” Multijugador P2P</title>
<style>
:root{--ui-bg:rgba(0,0,0,0.45);--accent:#1abc9c}
html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;background:linear-gradient(#6dd5ed,#2193b0);}
#canvas-container{width:100%;height:100%;overflow:hidden;position:fixed;left:0;top:0;}
#menu-screen{position:fixed;left:0;top:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;z-index:50;background:linear-gradient(180deg, rgba(0,0,0,0.65), rgba(0,0,0,0.45));}
.menu-card{width:95%;max-width:820px;background:var(--ui-bg);padding:18px;border-radius:12px;color:#fff;backdrop-filter:blur(6px);}
.menu-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;}
.menu-row input{flex:1;padding:10px;border-radius:8px;border:none;font-size:15px;}
.menu-row button{padding:10px 14px;border-radius:8px;border:none;background:var(--accent);color:#fff;font-weight:600;cursor:pointer;}
.menu-row button.secondary{background:rgba(255,255,255,0.12);color:#fff;}
.meta{font-size:13px;color:#dfefff;margin-top:8px;}
#status{margin-top:6px;color:#ffeb3b;}
#peerId{word-break:break-word;color:#9ef;margin-top:6px;}
#hud{position:fixed;left:12px;top:12px;z-index:40;color:#fff;background:var(--ui-bg);padding:8px;border-radius:8px;}
#mobile-controls{position:fixed;left:12px;bottom:12px;z-index:40;display:none;gap:8px;}
.touch-btn{width:64px;height:64px;border-radius:10px;background:rgba(255,255,255,0.08);border:none;color:#fff;font-weight:700;font-size:18px;}
@media (pointer:coarse){ #mobile-controls{display:flex;} }
#lobby-screen{position:fixed;left:0;top:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;z-index:60;background:rgba(0,0,0,0.6);color:white;flex-direction:column;}
#players-list{background:rgba(0,0,0,0.4);padding:10px 14px;border-radius:10px;max-width:400px;min-width:220px;}
</style>
</head>
<body>
<div id="canvas-container"></div>
<div id="menu-screen">
 <div class="menu-card">
  <h1>MiniCraft 3D â€” Multijugador P2P</h1>
  <div class="menu-row">
   <input id="playerName" placeholder="Tu nombre (opcional)" />
   <button id="createPeerBtn">Crear Sala</button>
   <button id="startLocalBtn" class="secondary">Mundo Local</button>
  </div>
  <div class="menu-row">
   <input id="connectIdInput" placeholder="ID del host" />
   <button id="connectPeerBtn" class="secondary">Unirse a Sala</button>
  </div>
  <div class="meta">
   <div id="status">Estado: Desconectado</div>
   <div id="peerId"></div>
  </div>
 </div>
</div>
<div id="lobby-screen">
  <h2>SALA</h2>
  <div>Tu ID: <span id="lobbyPeer"></span> <button id="copyId">Copiar</button></div>
  <div id="players-list"></div>
  <button id="readyBtn">Listo</button>
  <button id="startBtn" style="display:none;">Iniciar</button>
</div>
<div id="hud" style="display:none">Distancia: <span id="dist">0</span> m</div>
<div id="mobile-controls" style="display:none">
 <button id="btnLeft" class="touch-btn">â—€</button>
 <button id="btnRight" class="touch-btn">â–¶</button>
 <button id="btnJump" class="touch-btn">â–²</button>
 <button id="btnBreak" class="touch-btn">ðŸª“</button>
 <button id="btnPlace" class="touch-btn">â–¦</button>
</div>
<script src="https://cdn.jsdelivr.net/npm/three@0.156.1/build/three.min.js"></script>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
let peer, connections={}, players={}, myId=null, myName="Jugador", isHost=false, worldBlocks={};
const statusEl=document.getElementById('status'), peerIdEl=document.getElementById('peerId');
const lobby=document.getElementById('lobby-screen'), lobbyPeer=document.getElementById('lobbyPeer'), playersList=document.getElementById('players-list');
const readyBtn=document.getElementById('readyBtn'), startBtn=document.getElementById('startBtn');
let scene,camera,renderer,localPlayer;
function updatePlayersList(){playersList.innerHTML='';Object.values(players).forEach(p=>{const div=document.createElement('div');div.textContent=p.name+(p.ready?' âœ…':'');playersList.appendChild(div);});if(isHost)startBtn.style.display='block';}
function createPeer(){if(peer)peer.destroy();peer=new Peer();statusEl.textContent='Creando peer...';peer.on('open',id=>{myId=id;isHost=true;peerIdEl.textContent='Tu ID: '+id;lobbyPeer.textContent=id;document.getElementById('menu-screen').style.display='none';lobby.style.display='flex';players[id]={name:document.getElementById('playerName').value||'Host',ready:false,id};updatePlayersList();});peer.on('connection',conn=>{conn.on('data',d=>handleData(conn,d));conn.on('open',()=>{connections[conn.peer]=conn;players[conn.peer]={name:'Jugador_'+conn.peer.slice(0,4),ready:false,id:conn.peer};updatePlayersList();syncWorldTo(conn);});});}
function connectTo(id){if(!peer){peer=new Peer();peer.on('open',pid=>{myId=pid;});}const conn=peer.connect(id);conn.on('open',()=>{connections[id]=conn;isHost=false;conn.send({type:'join',name:document.getElementById('playerName').value||'Jugador'});document.getElementById('menu-screen').style.display='none';lobby.style.display='flex';});conn.on('data',d=>handleData(conn,d));}
function handleData(conn,data){if(data.type==='join'&&isHost){players[data.id||conn.peer]={name:data.name||'Invitado',ready:false,id:data.id||conn.peer};updatePlayersList();broadcast({type:'players',players});}
else if(data.type==='players'){players=data.players;updatePlayersList();}
else if(data.type==='ready'){if(players[data.id])players[data.id].ready=data.ready;updatePlayersList();}
else if(data.type==='start'){startWorld(true,data.spawns,data.players);}else if(data.type==='pos'){if(remoteMeshes[data.id])remoteMeshes[data.id].target.set(data.x,data.y,data.z);}else if(data.type==='syncWorld'){buildWorld(data.world);players=data.players;updatePlayersList();}}
function broadcast(obj){for(let id in connections){connections[id].send(obj);}}
readyBtn.onclick=()=>{players[myId].ready=!players[myId].ready;updatePlayersList();broadcast({type:'ready',id:myId,ready:players[myId].ready});}
startBtn.onclick=()=>{if(!isHost)return;let allReady=Object.values(players).every(p=>p.ready);if(!allReady){alert('Faltan jugadores listos');return;}let ids=Object.keys(players),spawns={};let angleStep=(Math.PI*2)/ids.length;ids.forEach((id,i)=>{spawns[id]={x:Math.cos(i*angleStep)*3,z:Math.sin(i*angleStep)*3,y:1};});broadcast({type:'start',spawns,players});startWorld(true,spawns,players);}
function syncWorldTo(conn){conn.send({type:'syncWorld',world:worldBlocks,players});}
let remoteMeshes={};
function startWorld(networked,spawns,playersList){lobby.style.display='none';document.getElementById('hud').style.display='block';scene=new THREE.Scene();scene.background=new THREE.Color(0x87ceeb);camera=new THREE.PerspectiveCamera(70,window.innerWidth/window.innerHeight,0.1,1000);renderer=new THREE.WebGLRenderer({antialias:true});renderer.setSize(window.innerWidth,window.innerHeight);document.getElementById('canvas-container').innerHTML='';document.getElementById('canvas-container').appendChild(renderer.domElement);
const hemi=new THREE.HemisphereLight(0xffffff,0x444444,0.9);scene.add(hemi);const dir=new THREE.DirectionalLight(0xffffff,0.8);dir.position.set(5,10,2);scene.add(dir);
const planeGeo=new THREE.BoxGeometry(20,1,20);const planeMat=new THREE.MeshStandardMaterial({color:0x228b22});const plane=new THREE.Mesh(planeGeo,planeMat);plane.position.y=-0.5;scene.add(plane);
function nameLabel(text){const c=document.createElement('canvas');const ctx=c.getContext('2d');ctx.font='20px Arial';const w=ctx.measureText(text).width+20;c.width=w;c.height=30;ctx.fillStyle='rgba(0,0,0,0.4)';ctx.fillRect(0,0,w,30);ctx.fillStyle='#fff';ctx.fillText(text,10,20);const tex=new THREE.CanvasTexture(c);const sprMat=new THREE.SpriteMaterial({map:tex});const spr=new THREE.Sprite(sprMat);spr.scale.set(w/40,0.6,1);return spr;}
for(let id in playersList){const spawn=spawns[id];const isMe=id===myId;const geom=new THREE.BoxGeometry(0.8,1,0.8);const mat=new THREE.MeshStandardMaterial({color:isMe?0x1abc9c:0xff5555});const mesh=new THREE.Mesh(geom,mat);mesh.position.set(spawn.x,spawn.y,spawn.z);scene.add(mesh);const label=nameLabel(playersList[id].name);label.position.set(0,1.2,0);mesh.add(label);if(isMe)localPlayer=mesh;else{mesh.target=new THREE.Vector3(spawn.x,spawn.y,spawn.z);remoteMeshes[id]=mesh;}}
window.addEventListener('resize',()=>{camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight);});
function animate(){requestAnimationFrame(animate);if(localPlayer){camera.position.lerp(new THREE.Vector3(localPlayer.position.x,localPlayer.position.y+2.5,localPlayer.position.z+5),0.1);camera.lookAt(localPlayer.position.x,localPlayer.position.y,localPlayer.position.z);}
for(let id in remoteMeshes){let m=remoteMeshes[id];if(m.target){m.position.lerp(m.target,0.2);}}
renderer.render(scene,camera);}
animate();setInterval(()=>{if(localPlayer){let p=localPlayer.position;for(let id in connections){connections[id].send({type:'pos',id:myId,x:p.x,y:p.y,z:p.z});}}},120);}
function buildWorld(world){worldBlocks=world;}
document.getElementById('createPeerBtn').onclick=()=>createPeer();
document.getElementById('connectPeerBtn').onclick=()=>{const id=document.getElementById('connectIdInput').value.trim();if(id)connectTo(id);};
</script>
</body>
</html>
